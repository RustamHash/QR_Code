#!/bin/bash
# –°–∫—Ä–∏–ø—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è QR Code Bot –Ω–∞ Timeweb Cloud
set -e

echo "üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ QR Code Bot –Ω–∞ Timeweb Cloud..."

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
apt update && apt upgrade -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤..."
apt install -y python3 python3-pip python3-venv git curl wget unzip

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞..."
mkdir -p /opt/qr_code_bot
cd /opt/qr_code_bot

# –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ –∑–µ—Ä–∫–∞–ª–æ
echo "üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞..."
if command -v curl &> /dev/null; then
    curl -L https://ghproxy.com/https://github.com/RustamHash/QR_Code/archive/refs/heads/main.zip -o qr_code.zip
elif command -v wget &> /dev/null; then
    wget https://ghproxy.com/https://github.com/RustamHash/QR_Code/archive/refs/heads/main.zip -O qr_code.zip
else
    echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ curl –∏–ª–∏ wget"
    exit 1
fi

# –†–∞—Å–ø–∞–∫–æ–≤–∫–∞
echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
unzip -q qr_code.zip
mv QR_Code-main/* .
mv QR_Code-main/.* . 2>/dev/null || true
rmdir QR_Code-main
rm qr_code.zip

# –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
echo "üêç –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
python3 -m venv venv
source venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
pip install --upgrade pip
pip install -r requirements.txt

# –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
echo "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env —Ñ–∞–π–ª–∞..."
if [ ! -f .env ]; then
    cp .env.example .env
    echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª .env –∏ —É–∫–∞–∂–∏—Ç–µ TELEGRAM_BOT_TOKEN!"
    echo "   nano /opt/qr_code_bot/.env"
fi

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
echo "üóÑÔ∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
alembic upgrade head

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ systemd service
echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ systemd service..."
cp qr-code-bot.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable qr-code-bot.service

echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env: nano /opt/qr_code_bot/.env"
echo "2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: systemctl start qr-code-bot"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: systemctl status qr-code-bot"

